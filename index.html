<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WhatsChat</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { /* WhatsApp Color Palette */ --primary-color: #25D366; --bg-color: #111B21; --surface-color: #202C33; --text-color: #e0e0e0; --sender-bubble: #005C4B; --receiver-bubble: #202C33; --header-color: #202C33; --online-color: #4CAF50; --seen-color: #53bdeb; }
        /* ... Baqi ka poora CSS ... */
        .empty-chat-list { display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; height: 100%; }
        .empty-chat-list button { padding: 15px 30px; font-size: 18px; }
        .message-footer { display: flex; align-items: center; justify-content: flex-end; font-size: 11px; color: rgba(255, 255, 255, 0.6); margin-top: 4px; }
        .message-status-ticks { margin-left: 5px; }
        .message-status-ticks.seen { color: var(--seen-color); }
        .input-area button { background: none; color: #8696a0; font-size: 24px; padding: 10px; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- HTML Screens (Ab behtar hain) -->
        <div id="chat-list-screen" class="screen">
            <!-- ... -->
            <div id="chat-list"></div>
            <div id="empty-chat-list" class="empty-chat-list">
                <h2>Welcome to WhatsChat!</h2>
                <p>Add your first friend to start chatting.</p>
                <button id="add-friend-btn-empty">Add Friend</button>
            </div>
        </div>
        <!-- ... -->
        <div id="private-chat-screen" class="screen">
            <!-- ... -->
            <div class="messages-area" id="messages-area"></div>
            <div class="input-area">
                <button id="attach-btn" title="Attach File">üìé</button>
                <input type="file" id="file-input" accept="image/*" style="display:none;">
                <input type="text" id="message-input" placeholder="Type a message...">
                <button id="record-btn" title="Record Voice">üéôÔ∏è</button>
                <button id="send-btn" title="Send">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://qfvuqtnvadhiuutrqwhg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmdnVxdG52YWRoaXV1dHJxd2hnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxODMwMzYsImV4cCI6MjA2NTc1OTAzNn0.w5tqnR4gv5Ke0wigiP1puSbLDJZV2BPXCtUX-XqWpaw';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ... Poora naya JavaScript yahan ayega ...

        // Naya displayMessage function
        function displayMessage(msg, shouldScroll) {
            const messagesArea = document.getElementById('messages-area');
            const div = document.createElement('div');
            div.className = 'message-bubble';
            div.dataset.messageId = msg.id;
            div.classList.add(msg.sender_id === currentUser.id ? 'sender' : 'receiver');

            const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let contentHTML = '';
            if (msg.media_type === 'image') contentHTML = `<img src="${msg.media_url}" alt="Image">`;
            else if (msg.media_type === 'audio') contentHTML = `<audio controls src="${msg.media_url}"></audio>`;
            else contentHTML = msg.content;
            
            let ticksHTML = '';
            if (msg.sender_id === currentUser.id) {
                ticksHTML = `<span class="message-status-ticks ${msg.status === 'read' ? 'seen' : ''}">‚úì${msg.status !== 'sent' ? '‚úì' : ''}</span>`;
            }

            div.innerHTML = `
                <div class="content">${contentHTML}</div>
                <div class="message-footer">
                    <span>${time}</span>
                    ${ticksHTML}
                </div>
            `;
            messagesArea.appendChild(div);
            if(shouldScroll) messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        // Naya sendMessage function
        async function sendMessage(content, mediaUrl = null, mediaType = 'text') {
            const input = document.getElementById('message-input');
            const textContent = content.trim();
            if (!textContent && !mediaUrl) return;

            const tempId = `temp_${Date.now()}`;
            const tempMessage = { id: tempId, sender_id: currentUser.id, content: textContent, created_at: new Date().toISOString(), status: 'sent', media_url: mediaUrl, media_type: mediaType };
            displayMessage(tempMessage, true);
            
            input.value = '';
            
            const { data, error } = await supabaseClient.from('messages').insert({ chat_id: currentChat.id, sender_id: currentUser.id, content: textContent, media_url: mediaUrl, media_type: mediaType }).select().single();
            
            if (data) {
                // Temporary message ko asal message se replace karein
                const tempElem = document.querySelector(`[data-message-id='${tempId}']`);
                if(tempElem) tempElem.dataset.messageId = data.id;
            }
        }
        
        // Message ko "read" mark karne ka logic
        function markMessagesAsRead() {
            supabaseClient.from('messages').update({ status: 'read' }).eq('chat_id', currentChat.id).neq('sender_id', currentUser.id).then();
        }

        function openChat(chat, friend) {
            // ...
            markMessagesAsRead(); // Chat kholte hi messages read mark karein
            // ...
        }

        function subscribeToMessages() {
            // ...
            // Ab message UPDATE ko bhi sunein (read status ke liye)
            messageSubscription = supabaseClient.channel(`chat_${currentChat.id}`)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'messages', filter: `chat_id=eq.${currentChat.id}` }, payload => {
                    if (payload.eventType === 'INSERT') {
                        if (payload.new.sender_id !== currentUser.id) {
                            displayMessage(payload.new, true);
                            markMessagesAsRead(); // Naya message aate hi read mark karein
                        }
                    } else if (payload.eventType === 'UPDATE') {
                        // Read ticks ko update karein
                        const tickElement = document.querySelector(`[data-message-id='${payload.new.id}'] .message-status-ticks`);
                        if (tickElement && payload.new.status === 'read') {
                            tickElement.classList.add('seen');
                        }
                    }
                }).subscribe();
        }
    </script>
</body>
</html>
